---
applyTo: '**'
---

任何与壁纸源有关的代码和说明需遵守此协议：

小树壁纸源协议 v2.0

1. 协议标识
   - 字段名：scheme
   - 类型：字符串
   - 值：必须为 "littletree_wallpaper_source_v2"
   - 必填：是

2. 全局元数据（顶层字段）
   2.1 identifier
       - 类型：字符串
       - 必填：是
       - 约束：长度 3–32 字符；仅允许小写字母、数字、下划线（[a-z0-9_]）
       - 用途：系统内部唯一标识，不用于 UI 展示
   2.2 name
       - 类型：字符串
       - 必填：是
       - 用途：在客户端市场/设置中显示的名称
   2.3 version
       - 类型：字符串
       - 必填：是
       - 格式：语义化版本（如 "1.0.0"）
   2.4 description
       - 类型：字符串
       - 必填：否
       - 约束：长度 ≤ 100 字符
   2.5 details
       - 类型：字符串
       - 必填：否
       - 格式：支持完整 Markdown
   2.6 logo
       - 类型：字符串
       - 必填：否
       - 格式：HTTPS URL 或 data:image Base64
   2.7 skip_ssl_verify
       - 类型：布尔值
       - 必填：否
       - 默认值：false
   2.8 refresh_interval_seconds
       - 类型：整数（≥0）
       - 必填：否
       - 默认值：0
       - 含义：
           - 0 表示无刷新频率限制（可随时请求）
           - 正整数表示相同 API 在该秒数内不会重复请求
   2.9 footer_text
       - 类型：字符串
       - 必填：否
       - 用途：显示在壁纸详情页底部的版权或提示文本

3. 分类定义（[[categories]] 数组）
   每个元素为一个分类对象，必须包含以下字段：
   3.1 id
       - 类型：字符串
       - 必填：是
       - 约束：同 identifier（3–32 字符，[a-z0-9_]）
       - 用途：API 绑定时引用的唯一键
   3.2 name
       - 类型：字符串
       - 必填：是
       - 用途：分类在 UI 中的显示名称
   3.3 category
       - 类型：字符串
       - 必填：是
       - 用途：一级分类名称（如 "自然"）
   3.4 subcategory
       - 类型：字符串
       - 必填：否
       - 用途：二级分类名称（如 "山脉"）
   3.5 subsubcategory
       - 类型：字符串
       - 必填：否
       - 用途：三级分类名称（如 "雪景"）
   注：客户端根据 (category, subcategory, subsubcategory) 三元组聚合分类，与 id 无关。

4. 参数预设（[[parameters]] 数组）
   每个参数组包含：
   4.1 id
       - 类型：字符串
       - 必填：是
       - 约束：全局唯一
   4.2 options（数组）
       每个选项对象包含：
       4.2.1 key
             - 类型：字符串
             - 必填：是
             - 用途：作为请求参数名
       4.2.2 type
             - 类型：字符串
             - 必填：是
             - 取值："choice" / "boolean" / "text"
       4.2.3 label
             - 类型：字符串
             - 必填：是，除非 hidden = true
             - 用途：UI 显示标题
       4.2.4 default
             - 类型：字符串
             - 必填：是
             - 说明：作为实际请求值
       4.2.5 choices
             - 类型：字符串数组
             - 必填：仅当 type = "choice" 时必填
       4.2.6 placeholder
             - 类型：字符串
             - 必填：否
             - 有效条件：仅当 type = "text"
       4.2.7 hidden
             - 类型：布尔值
             - 必填：否
             - 默认值：false
             - 行为：
                 - true：不在 UI 显示，但仍以 default 值参与请求
                 - false：正常显示并可编辑

5. API 定义（[[apis]] 数组）
   每个 API 对象必须满足：
   5.1 至少绑定一个分类（通过 category_ids 或 category_param_mapping）
   5.2 字段定义：
       5.2.1 name
             - 类型：字符串
             - 必填：是
       5.2.2 url
             - 类型：字符串
             - 必填：当 format 为 json/toml/image_url/image_base64/image_raw 时必填
             - 可选：当 format 为 static_list 或 static_dict 时禁止出现
       5.2.3 format
             - 类型：字符串
             - 必填：是
             - 取值及行为：
                 - "json"：
                     - 响应体为 JSON
                     - field_mapping 使用 JSON Pointer 语法（如 "/data/0/url"）
                     - 支持 multi、参数、field_mapping
                 - "toml"：
                     - 响应体为 TOML 文本
                     - field_mapping 使用点号路径（如 "data.0.url"）
                     - 支持 multi、参数、field_mapping
                 - "image_url"：
                     - 响应体为纯文本 URL
                     - 自动去除首尾空白字符（等价于 .trim()）
                     - 不支持参数、field_mapping、multi
                 - "static_list"：
                     - 无网络请求
                     - 通过 [apis.static_list] 定义 urls 数组
                     - 每项仅为图片 URL 字符串
                     - 不支持标题、描述、参数、field_mapping、multi
                 - "static_dict"：
                     - 无网络请求
                     - 通过 [apis.static_dict.items] 定义对象数组
                     - 每项包含：
                         - url（字符串，必填）
                         - title（字符串，可选）
                         - description（字符串，可选）
                     - 不支持参数、field_mapping、multi
                 - "image_base64" / "image_raw"：
                     - 不支持参数、field_mapping、multi
       5.2.4 method
             - 类型：字符串
             - 必填：否
             - 默认值："GET"
             - 取值："GET" / "POST"
       5.2.5 category_ids
             - 类型：字符串（单分类）或字符串数组（多分类）
             - 必填：若未使用 category_param_mapping，则必填
             - 约束：所引用的 id 必须在 [[categories]] 中已定义
       5.2.6 param_preset_id
             - 类型：字符串
             - 必填：否
             - 有效条件：仅当使用 category_ids（单分类或多分类统一参数）时有效
             - 约束：所引用的 id 必须在 [[parameters]] 中已定义
       5.2.7 category_param_mapping
             - 类型：表（字典，键值均为字符串）
             - 必填：否
             - 有效条件：仅当未使用 category_ids 时可使用
             - 格式：{ "分类ID1" = "参数ID1", "分类ID2" = "参数ID2" }
             - 约束：所有键必须在 [[categories]] 中存在，所有值必须在 [[parameters]] 中存在
       5.2.8 互斥规则：
             - category_ids 与 category_param_mapping 不能同时存在
             - 若同时出现，解析失败

   5.3 [apis.field_mapping]（仅适用于 json/toml）
       - image：必填，路径字符串
       - title：可选
       - description：可选
       - copyright：可选
       - 路径语法：
           - format = "json" → JSON Pointer（RFC 6901）
           - format = "toml" → 点号分隔路径（如 "items.0.title"）

   5.4 [apis.multi]（仅适用于 json/toml）
       - enabled：布尔值，必须为 true 才启用多图
       - items_path：字符串，指向壁纸对象数组的路径（语法同 field_mapping）

   5.5 [apis.static_list]
       - urls：字符串数组，每项为有效 HTTPS 图片 URL

   5.6 [apis.static_dict]
       - items：对象数组，每个对象包含：
           - url：字符串，必填
           - title：字符串，可选
           - description：字符串，可选

6. 客户端行为规范
   6.1 请求参数处理：
       - GET：所有参数（含 hidden=true）拼接到 URL 查询字符串
       - POST：所有参数（含 hidden=true）作为 JSON 对象放入 Body
   6.2 分类聚合：
       - 相同 (category, subcategory, subsubcategory) 的分类自动合并
       - 不同源的内容在同一分类下展示
   6.3 刷新控制：
       - refresh_interval_seconds = 0 → 无限制
       - >0 → 该 API 在指定秒数内最多请求一次
   6.4 image_url 处理：
       - 响应体经 .trim() 后解析为 URL
       - 空响应或无效 URL 将被忽略
   6.5 footer_text 优先级：
       - 若 API 级别定义了 footer_text，则覆盖全局值
       - 否则使用全局 footer_text

7. 安全与最佳实践
   7.1 壁纸源文件以纯文本形式分发，无加密
   7.2 严禁在源文件中硬编码 API 密钥、Token 等敏感信息
   7.3 推荐使用 hidden=true 传递固定内部参数（如 format=json）
   7.4 合理设置 refresh_interval_seconds 避免第三方 API 限流

8. 版本信息
   - 协议版本：v2.0
   - 生效日期：2025-11-01
   - 适用产品：小树壁纸 Next（Little Tree Wallpaper Next）
